plugins:
  verifier:
    conditions:
      proc_mtd_dynamic:
        type: file_contains
        file: console.log
        string: "/tests/proc_mtd_dynamic.sh PASS"

pseudofiles:
  /dev/mtd100:
    name: fakemtd

static_files:
  /tests/proc_mtd_dynamic.sh:
    type: inline_file
    contents: |
      #!/igloo/utils/micropython

      import ffi

      lib_inject = ffi.open("lib_inject.so")

      strstr = lib_inject.func("s", "libinject_strstr", "ss")

      device_path = None
      with open("/proc/mtd") as f:
        for line in f:
          if strstr(line, "flash"):
            device = line.split(":")[0]
            device_path = f"/dev/{device}"
            break

      print("flash device path:", device_path)
    mode: 73
