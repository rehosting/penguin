plugins:
  portalcall_test: {}
  verifier:
    conditions:
      portalcall_hypervisor_test:
        type: file_contains
        file: portalcall_test.txt
        string: "PORTALCALL test: passed"
      portalcall_guest+stdout:
        type: file_contains
        file: shared/tests/portalcall.sh/stdout
        string: "do_portalcall returned: 13"
      portalcall_guest+stdout_retval:
        type: file_contains
        file: shared/tests/portalcall.sh/stdout
        string: "send_portalcall retval correct"

static_files:
  /tests/portalcall.sh:
    type: inline_file
    contents: |
      #!/igloo/utils/sh
      set -x
      set +e # ignore non-zero exit code
      /igloo/utils/send_portalcall 0xcafebabe 0xdeadbeeff1f1f1f1 0x1337c0defeedc0de 0xdeadbeeff1f1f1f2 0x1337c0def2f2f2f2
      if [ $? -ne 13 ]; then
        echo "Error: Portalcall failed"
        exit 1
      else
        echo "send_portalcall retval correct"
        exit 0
      fi
    mode: 73
