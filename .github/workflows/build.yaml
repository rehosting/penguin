name: Test and Release Container

on:
  pull_request:
    branches:
      - main

jobs:
  build_container:
    runs-on: ubuntu-latest
    
    # Sets the permissions granted to the `GITHUB_TOKEN` for the actions in this job.
    # (required)
    permissions:
      contents: write
      packages: write

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: rehosting
          password: ${{secrets.DOCKERHUB_TOKEN}}
      
      - name: Pull latest Docker image for cache
        run: docker pull rehosting/penguin:latest || true
      
      - name: Logout
        run: docker logout
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image and push to GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/rehosting/penguin:${{ github.sha }}
          cache-from: type=registry,ref=rehosting/penguin:latest
          cache-to: type=inline

  run_tests:
    needs: build_container
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        kernel: ["4.10"]
        arch: ["armel", "mipsel", "mipseb", "mips64eb", "aarch64"]
        test:
          - env_unset
          - env_cmp
          - pseudofile_missing
          - pseudofile_ioctl
          - hostfile
          - shared_dir
          - net_missing
          - netdevs
          - proc_self
          - pseudofile_readdir
          - pseudofile_mmap_shared
          - bash
          - proc_mtd_dynamic
          - proc_mtd_missing
          - proc_mtd
          - pseudofile_devfs
          - pseudofile_sysfs
          - uboot_env_cmp

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # Locally tag as latest, just for testing
      - name: Pull the image from Dockerhub
        run: |
              docker pull ghcr.io/rehosting/penguin:${{ github.sha }};
              docker tag ghcr.io/rehosting/penguin:${{ github.sha }} rehosting/penguin:latest

      - name: Test ${{ matrix.test }} for ${{ matrix.arch }} kernel v${{ matrix.kernel }}
        run: timeout 5m python3 $GITHUB_WORKSPACE/tests/unit_tests/test.py --kernel-version ${{ matrix.kernel }} --arch ${{ matrix.arch }} --test ${{ matrix.test }}

  remove-docker-tag:
    runs-on: ubuntu-latest
    if:  always()
    needs: run_tests

    # Sets the permissions granted to the `GITHUB_TOKEN` for the actions in this job.
    # (required)
    permissions:
      contents: read
      packages: write

    steps:
    - name: Remove Docker Tag
      uses: rafalkk/remove-dockertag-action@v1
      with:
        tag_name: ${{ github.sha }}
        github_token: ${{ secrets.GITHUB_TOKEN }}

    - uses: actions/delete-package-versions@v5
      with: 
        package-name: 'penguin'
        package-type: 'container'
        min-versions-to-keep: 0
        delete-only-untagged-versions: 'true'