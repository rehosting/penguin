#!/igloo/utils/micropython
import sys
import ujson

CONFIG_PATH = "/igloo/config.json"
with open(CONFIG_PATH) as f:
    config = ujson.load(f)

def get_nested_value(data, path):
    keys = path.split('.')
    current = data

    for key in keys:
        if isinstance(current, dict) and key in current:
            current = current[key]
        else:
            return None

    return current

# Bool mode means we exit with 0 if the value is truthy, 1 if falsy or not found
bool_mode = False
args = sys.argv[1:]

if '--bool' in args:
    bool_mode = True
    args.remove('--bool')

if len(args) > 0:
    path = args[0]
    value = get_nested_value(config, path)

    if bool_mode:
        if value is None:
            sys.exit(1)
        else:
            sys.exit(0 if value else 1)
    else:
        if value is not None:
            if isinstance(value, (dict, list)):
                print(ujson.dumps(value))
            else:
                print(str(value))
        else:
            print("Key not found", file=sys.stderr)
            sys.exit(1)
else:
    print("Usage: get_config [--bool] <key.path>", file=sys.stderr)
    sys.exit(1)
